<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MI PT Coach — Agenda Mapping • BAP • WOOP • TTM • COM‑B</title>
<style>
  :root{
    --bg:#0f172a;          /* slate-900 */
    --panel:#111827;       /* gray-900 */
    --muted:#1f2937;       /* gray-800 */
    --soft:#111827;        /* panels */
    --card:#0b1328;        /* deep slate */
    --ink:#e5e7eb;         /* gray-200 */
    --ink-dim:#a5b4fc;     /* indigo-200 */
    --brand:#22c55e;       /* emerald-500 */
    --brand-2:#38bdf8;     /* sky-400 */
    --warn:#f59e0b;        /* amber-500 */
    --danger:#ef4444;      /* red-500 */
    --ok:#10b981;          /* green-500 */
  }
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0a0f1f, #0b1223 40%, #0d1429);
       color:var(--ink);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;
       -webkit-font-smoothing:antialiased}
  .wrap{max-width:1200px;margin:0 auto;padding:20px 16px 60px}
  header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .title{display:flex;gap:10px;align-items:center}
  .logo{width:28px;height:28px;border-radius:8px;background:radial-gradient(circle at 25% 25%, var(--brand), #094b2d 60%);box-shadow:0 0 0 2px #06301e,0 8px 24px rgba(34,197,94,.35)}
  h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}
  .sub{opacity:.7;font-size:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .chip{display:inline-flex;align-items:center;gap:6px;background:#111827;border:1px solid #1f2a45;color:#c7d2fe;padding:6px 10px;border-radius:22px;cursor:pointer;transition:.15s}
  .chip:hover{border-color:#334155;transform:translateY(-1px)}
  .btn{background:linear-gradient(180deg,#1f2937,#0f172a);border:1px solid #273249;color:#e5e7eb;padding:10px 12px;border-radius:12px;cursor:pointer;transition:.15s;box-shadow:0 4px 16px rgba(0,0,0,.25)}
  .btn:hover{transform:translateY(-1px);border-color:#3b82f6}
  .btn.primary{background:linear-gradient(180deg,#0ea5e9,#0ea5e980);border-color:#22d3ee;color:#07121c}
  .btn.success{background:linear-gradient(180deg,#22c55e,#22c55e80);border-color:#10b981;color:#052411}
  .btn.warn{background:linear-gradient(180deg,#f59e0b,#f59e0b80);border-color:#ca8a04;color:#2c1600}
  .btn.ghost{background:transparent;border:1px dashed #334155}
  .switch{display:inline-flex;align-items:center;gap:8px}
  .switch input{appearance:none;width:44px;height:24px;background:#111827;border:1px solid #334155;border-radius:20px;position:relative;outline:none;cursor:pointer;transition:.2s}
  .switch input:checked{background:#064e3b;border-color:#10b981}
  .switch input:before{content:"";position:absolute;width:18px;height:18px;left:3px;top:2.5px;background:#cbd5e1;border-radius:20px;transition:.2s}
  .switch input:checked:before{left:22px;background:#ecfeff}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 16px}
  .tab{padding:10px 12px;border-radius:12px;background:#0b1328;border:1px solid #1e293b;color:#cbd5e1;cursor:pointer}
  .tab.active{background:linear-gradient(180deg,#0b2c40,#0a2031);border-color:#38bdf8;color:#e0f2fe;box-shadow:0 6px 24px rgba(56,189,248,.25)}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:repeat(2,1fr)}
  .g3{grid-template-columns:repeat(3,1fr)}
  .card{background:radial-gradient(1200px 300px at 0% -10%, #0b2a3d10, transparent), #0a1020;border:1px solid #1e293b;border-radius:16px;padding:14px}
  .card h3{margin:0 0 8px;font-size:14px;color:#e2e8f0}
  .muted{opacity:.8}
  input[type=range]{width:100%}
  input,select,textarea{background:#0b142b;color:#e5e7eb;border:1px solid #243045;border-radius:10px;padding:9px 10px;outline:none}
  textarea{min-height:90px}
  .cols{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .dropcol{min-height:120px;padding:10px;border-radius:12px;border:1px dashed #334155;background:linear-gradient(180deg,#0b142b,#0a1020)}
  .mini{font-size:12px;opacity:.9}
  .stat{background:#0b142b;border:1px solid #1f2a45;border-radius:12px;padding:10px;text-align:center}
  .stat b{font-size:18px}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid #334155;border-radius:999px;padding:6px 10px;font-size:12px}
  .good{color:#86efac;border-color:#14532d}
  .meh{color:#fde68a;border-color:#78350f}
  .bad{color:#fecaca;border-color:#7f1d1d}
  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .right{margin-left:auto}
  .hl{color:#67e8f9}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0b142b;border:1px solid #334155;border-radius:6px;padding:2px 6px;font-size:12px}
  .progress{height:8px;background:#0b142b;border:1px solid #1f2a45;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0;background:linear-gradient(90deg,#22c55e,#38bdf8);transition:width .3s ease}
  .footer{opacity:.65;margin-top:16px}
  .hide{display:none !important}
  .pill{padding:3px 8px;border-radius:999px;background:#0b142b;border:1px solid #334155}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>MI PT Coach</h1>
        <div class="sub">Agenda mapping • MI Coach • BAP • WOOP • TTM • COM‑B • MITI scorecard • SDT</div>
      </div>
    </div>
    <div class="row" role="group" aria-label="Quick controls">
      <label class="switch" title="Practice Mode (no PHI stored)"><input id="modePractice" type="checkbox" checked><span>Practice</span></label>
      <label class="switch" title="PHI redaction on exports"><input id="phiToggle" type="checkbox" checked><span>PHI‑safe</span></label>
      <button class="btn" id="btnPTReset" title="10‑second PT reset (reduce righting reflex)">PT 10‑sec reset</button>
    </div>
  </header>

  <nav class="tabs" role="tablist">
    <button class="tab active" data-tab="agenda">Agenda Map</button>
    <button class="tab" data-tab="coach">MI Coach</button>
    <button class="tab" data-tab="plan">Plan Builder</button>
    <button class="tab" data-tab="debrief">Debrief</button>
    <button class="tab" data-tab="drills">Micro‑drills</button>
    <button class="tab" data-tab="settings">Settings</button>
  </nav>

  <!-- AGENDA MAP -->
  <section id="agenda" class="tabpane">
    <div class="grid g2">
      <div class="card">
        <h3>Setting preset</h3>
        <div class="flex">
          <select id="settingPreset">
            <option value="OP">Outpatient Orthopedics</option>
            <option value="SNF">Skilled Nursing Facility</option>
            <option value="Pelvic">Pelvic Health</option>
            <option value="Sports">Sports</option>
            <option value="Neuro">Neuro Rehab</option>
          </select>
          <button class="btn" id="loadPreset">Load</button>
          <span class="mini">Presets swap in relevant <span class="hl">values</span> & <span class="hl">concerns</span> chips.</span>
        </div>
      </div>
      <div class="card">
        <h3>Stage snap (TTM)</h3>
        <div class="grid g2">
          <label>Stage
            <select id="stage">
              <option>Pre‑contemplation</option>
              <option>Contemplation</option>
              <option>Preparation</option>
              <option>Action</option>
              <option>Maintenance</option>
            </select>
          </label>
          <label>Time budget (min)
            <input type="number" id="timeBudget" value="15" min="5" max="90" />
          </label>
        </div>
        <div class="grid g3" style="margin-top:8px">
          <div>
            <div class="mini">Importance (0–10)</div>
            <input type="range" min="0" max="10" id="imp" value="5"/>
            <div class="flex"><b id="impVal">5</b><span class="mini">Evoke DARN before CAT if low</span></div>
          </div>
          <div>
            <div class="mini">Confidence (0–10)</div>
            <input type="range" min="0" max="10" id="conf" value="6"/>
            <div class="flex"><b id="confVal">6</b><span class="mini">Scale plan difficulty if low</span></div>
          </div>
          <div>
            <div class="mini">Readiness (0–10)</div>
            <input type="range" min="0" max="10" id="ready" value="5"/>
            <div class="flex"><b id="readyVal">5</b><span class="mini">Use focusing if low</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid g2" style="margin-top:12px">
      <div class="card">
        <h3>Patient values</h3>
        <div id="valuesBank" class="row"></div>
        <div class="flex" style="margin-top:8px">
          <input id="customValue" placeholder="Add a custom value…" />
          <button class="btn" id="addValue">Add</button>
        </div>
      </div>
      <div class="card">
        <h3>Concerns / topics</h3>
        <div id="concernBank" class="row"></div>
        <div class="flex" style="margin-top:8px">
          <input id="customConcern" placeholder="Add a custom concern…" />
          <button class="btn" id="addConcern">Add</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Agenda buckets (click a chip to cycle buckets)</h3>
      <div class="cols">
        <div>
          <div class="mini">Must discuss</div>
          <div id="colMust" class="dropcol" aria-live="polite"></div>
        </div>
        <div>
          <div class="mini">If time</div>
          <div id="colIf" class="dropcol" aria-live="polite"></div>
        </div>
        <div>
          <div class="mini">Defer</div>
          <div id="colDefer" class="dropcol" aria-live="polite"></div>
        </div>
      </div>
      <div class="flex" style="margin-top:10px">
        <button class="btn primary" id="btnFocus">Suggest focus</button>
        <div class="stat"><div class="mini">Focus suggestion</div><b id="focusOut">—</b></div>
      </div>
    </div>
  </section>

  <!-- MI COACH -->
  <section id="coach" class="tabpane hide">
    <div class="grid g3">
      <div class="card">
        <h3>OARS prompts <span class="mini">(shortcuts: <span class="kbd">O</span>/<span class="kbd">A</span>/<span class="kbd">R</span>/<span class="kbd">S</span>)</span></h3>
        <div id="oarsBtns" class="grid" style="grid-template-columns:repeat(2,1fr)"></div>
        <div class="progress" style="margin-top:8px"><div id="ratioBar" class="bar" style="width:50%"></div></div>
        <div class="mini">Reflections : Questions = <b id="rq">1.0</b> (target ≥ 1.0)</div>
      </div>
      <div class="card">
        <h3>DARN‑CAT tracker</h3>
        <div id="darncatBtns" class="grid" style="grid-template-columns:repeat(3,1fr)"></div>
        <div class="grid g3" style="margin-top:8px">
          <div class="stat"><div class="mini">Change talk</div><b id="ctPct">0%</b></div>
          <div class="stat"><div class="mini">Sustain talk</div><b id="stCnt">0</b></div>
          <div class="stat"><div class="mini">Highlights</div><b id="hiCnt">0</b></div>
        </div>
      </div>
      <div class="card">
        <h3>COM‑B quick check</h3>
        <div class="row">
          <label class="badge"><input type="checkbox" id="cCap"> Capability</label>
          <label class="badge"><input type="checkbox" id="cOpp"> Opportunity</label>
          <label class="badge"><input type="checkbox" id="cMot"> Motivation</label>
        </div>
        <div id="bctSuggest" class="mini" style="margin-top:8px">Toggle gaps to see suggested techniques.</div>
        <div class="row" id="bctTags" style="margin-top:6px"></div>
        <div class="card" style="margin-top:8px"><div class="mini">SDT‑aligned prompts</div><div id="sdtPrompts"></div></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Live prompt</h3>
      <div id="livePrompt" class="pill" style="padding:10px 12px">Tap OARS to get a suggested MI‑consistent line…</div>
      <div class="flex" style="margin-top:8px">
        <button class="btn ghost" id="btnUndo">Undo last</button>
        <button class="btn right" id="btnAddHighlight">Save as highlight</button>
      </div>
    </div>
  </section>

  <!-- PLAN BUILDER -->
  <section id="plan" class="tabpane hide">
    <div class="grid g2">
      <div class="card">
        <h3>Brief Action Planning (Fast lane)</h3>
        <label>What might you try in the next week or two?
          <textarea id="bapTry" placeholder="e.g., Walk 10 minutes after lunch on M/W/F"></textarea>
        </label>
        <div class="grid g3">
          <label>Confidence (0–10)
            <input type="range" min="0" max="10" id="bapConf" value="7">
          </label>
          <label>Importance (0–10)
            <input type="range" min="0" max="10" id="bapImp" value="7">
          </label>
          <label>Follow‑up (days)
            <input type="number" id="bapFU" value="14" min="3" max="60">
          </label>
        </div>
        <div class="flex" style="margin-top:8px">
          <button class="btn success" id="saveBAP">Save BAP</button>
          <span class="mini">App auto‑adds BCTs + coping plan if confidence &lt; 7.</span>
        </div>
      </div>

      <div class="card">
        <h3>Advanced Goal (SMARTER + If‑Then + WOOP)</h3>
        <div class="grid g2">
          <label>Specific goal
            <input id="gSpecific" placeholder="What, where, when" />
          </label>
          <label>Metric
            <input id="gMetric" placeholder="How measured (steps/mins/reps)" />
          </label>
          <label>Challenge level
            <select id="gChallenge"><option>Easy</option><option selected>Right‑sized</option><option>Stretch</option></select>
          </label>
          <label>Feedback cadence
            <select id="gFeedback"><option>Daily</option><option selected>Weekly</option><option>Bi‑weekly</option></select>
          </label>
        </div>
        <label>Obstacles → If‑Then plans
          <textarea id="ifThen" placeholder="If my knee hurts in the evening, then I will switch to seated cycling for 10 min."></textarea>
        </label>
        <div class="grid g2">
          <label>WOOP: Wish / Outcome
            <input id="woopWO" placeholder="Wish + best outcome" />
          </label>
          <label>WOOP: Obstacle / Plan
            <input id="woopOP" placeholder="Main obstacle + plan" />
          </label>
        </div>
        <div class="flex" style="margin-top:8px">
          <button class="btn success" id="saveGoal">Save Goal</button>
          <button class="btn" id="btnPatientReset">Generate 10‑sec patient reset</button>
        </div>
        <div id="patientReset" class="pill" style="margin-top:8px"></div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Exports</h3>
      <div class="flex">
        <button class="btn" id="exportNote">Copy SOAP/MI note</button>
        <button class="btn" id="exportPlan">Copy patient plan</button>
        <button class="btn" id="exportJSON">Download de‑identified JSON</button>
      </div>
      <textarea id="exportOut" class="hide" readonly></textarea>
    </div>
  </section>

  <!-- DEBRIEF -->
  <section id="debrief" class="tabpane hide">
    <div class="grid g3">
      <div class="card">
        <h3>MITI‑style metrics</h3>
        <div class="grid g3">
          <div class="stat"><div class="mini">Open Q %</div><b id="mOpen">0%</b></div>
          <div class="stat"><div class="mini">Reflections:Questions</div><b id="mRQ">0.0</b></div>
          <div class="stat"><div class="mini">Complex refl. %</div><b id="mCR">0%</b></div>
        </div>
        <div class="mini" style="margin-top:6px">Targets: ↑ open questions, ≥ 1.0 reflections:questions, ↑ complex reflections.</div>
      </div>
      <div class="card">
        <h3>Change talk heatmap</h3>
        <div class="row" id="ctHeat"></div>
      </div>
      <div class="card">
        <h3>Achievements</h3>
        <div id="achieve" class="row"></div>
      </div>
    </div>

    <div class="grid g2" style="margin-top:12px">
      <div class="card">
        <h3>Highlights</h3>
        <div id="highlights" class="row"></div>
      </div>
      <div class="card">
        <h3>Supervisor mode</h3>
        <label class="switch"><input id="supervisor" type="checkbox"><span>Enable</span></label>
        <div class="mini">Share de‑identified summary for mentoring.</div>
        <button class="btn" id="copySummary" style="margin-top:8px">Copy de‑identified summary</button>
        <textarea id="summaryOut" class="hide" readonly></textarea>
      </div>
    </div>
  </section>

  <!-- DRILLS -->
  <section id="drills" class="tabpane hide">
    <div class="grid g3">
      <div class="card">
        <h3>Only Reflections (2 min)</h3>
        <div class="mini">Respond to prompts using only reflections—no questions.</div>
        <button class="btn" onclick="startDrill('reflections')">Start</button>
      </div>
      <div class="card">
        <h3>Affirmations Burst (90 sec)</h3>
        <div class="mini">Spot strengths & efforts; produce specific affirmations.</div>
        <button class="btn" onclick="startDrill('affirmations')">Start</button>
      </div>
      <div class="card">
        <h3>Evocation Ladder (2 min)</h3>
        <div class="mini">Climb Desire→Ability→Reasons→Need with open Qs.</div>
        <button class="btn" onclick="startDrill('evocation')">Start</button>
      </div>
    </div>
    <div class="card" style="margin-top:12px">
      <h3>Drill Console</h3>
      <div id="drillPrompt" class="pill">Choose a drill to begin…</div>
      <div class="progress" style="margin:8px 0"><div id="drillBar" class="bar"></div></div>
      <div class="row"><button class="btn ghost" onclick="stopDrill()">Stop</button></div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="settings" class="tabpane hide">
    <div class="grid g2">
      <div class="card">
        <h3>Privacy & retention</h3>
        <label>Retention (days)
          <select id="retention"><option value="0">No store (session only)</option><option value="7">7</option><option value="30" selected>30</option></select>
        </label>
        <div class="flex" style="margin-top:8px">
          <button class="btn warn" id="purge">Purge saved data</button>
          <span class="mini">Local‑first only; nothing leaves your browser.</span>
        </div>
      </div>
      <div class="card">
        <h3>Shortcuts</h3>
        <div class="mini">O=Open Q, A=Affirm, R=Reflection, S=Summary. U=Undo.</div>
      </div>
    </div>
    <div class="footer mini">© MI PT Coach — single‑file prototype. For education only. Avoid entering PHI in Practice mode.</div>
  </section>

  <!-- PT 10-second reset modal-ish strip -->
  <div id="ptReset" class="card hide" style="position:fixed;left:50%;bottom:20px;transform:translateX(-50%);width:min(720px,94vw);box-shadow:0 16px 48px rgba(0,0,0,.45);z-index:50">
    <div class="flex"><b>PT 10‑second reset</b><button class="btn right" onclick="hidePTReset()">Close</button></div>
    <div class="progress" style="margin:8px 0 6px"><div id="ptBar" class="bar"></div></div>
    <div id="ptScript" class="mini"></div>
  </div>
</div>

<script>
// ------------------------
// Simple state
// ------------------------
const state = {
  modePractice:true,
  phiSafe:true,
  setting:"OP",
  stage:"Pre‑contemplation",
  timeBudget:15,
  values:[],
  concerns:[],
  agenda:{Must:[], If:[], Defer:[]},
  oars:{openQ:0, closedQ:0, affirm:0, reflSimple:0, reflComplex:0, summary:0},
  darncat:{D:0,A:0,R:0,N:0,C:0,AbilityTalk:0,T:0,Sustain:0},
  highlights:[],
  comB:{cap:false,opp:false,mot:false, bcts:[]},
  bap:null,
  goal:null,
  xp:0,badges:[],
  savedAt: Date.now()
};

// Presets
const PRESETS={
  OP:{values:["Family","Independence","Work","Faith","Sport","Energy","Sleep"],
      concerns:["Pain","Function","Activity plan","Sleep","Medication load","Fear of movement","Return to sport"]},
  SNF:{values:["Dignity","Safety","Comfort","Family","Autonomy"],
      concerns:["Transfers","Falls","Walking","Pain","Swelling","Caregiver training"]},
  Pelvic:{values:["Privacy","Intimacy","Comfort","Confidence","Parenting"],
      concerns:["Pelvic pain","Leakage","Prolapse","Constipation","Dyspareunia"]},
  Sports:{values:["Performance","Team","Fun","Discipline","Scholarship"],
      concerns:["Return to play","Load mgmt","Soreness","Sleep","Nutrition","Cross‑training"]},
  Neuro:{values:["Independence","Communication","Mobility","Family","Cognition"],
      concerns:["Transfers","Balance","Spasticity","Fatigue","Home setup","Caregiver strain"]}
};

// BCT suggestions for COM-B gaps
const BCTS = {
  cap:["Instruction on how to perform behavior","Demonstration of behavior","Graded tasks","Habit formation"],
  opp:["Prompts/cues","Restructuring physical environment","Adding objects to the environment","Social support (practical)"],
  mot:["Pros/cons decisional balance","Verbal persuasion about capability","Self‑monitoring of behavior","Action planning"]
};

// OARS prompt banks
const OARS={
  open:[
    "What matters most to you about getting back to ",
    "In what ways has this been affecting your day?",
    "What would a small first step look like?",
    "What gives you confidence you could try this?"
  ],
  affirm:[
    "You’ve kept showing up—that speaks to your commitment.",
    "You balanced work and rehab last week; that took planning.",
    "It took courage to talk about this today."
  ],
  reflSimple:[
    "You’re feeling stuck and tired.",
    "Pain has made it harder to trust your body.",
    "Routine changes threw you off."
  ],
  reflComplex:[
    "Even with the setbacks, you’re noticing moments where movement actually helps—
    and that’s shaping your thinking.",
    "Part of you worries about pain, and another part really wants your evenings back."
  ],
  summary:[
    "Let me summarize: family time and steady energy matter most; walking 10 minutes M/W/F feels doable if evenings are hard."
  ]
};

// Drill content
const DRILLS={
  reflections:[
    "I’m too busy to exercise.","My knee always hurts after activity.","Last time PT didn’t help much.","I want to keep up with my kids."],
  affirmations:[
    "I tracked my steps twice last week.","I asked my partner for help once.","I came today even though I was nervous.","I read the handout."],
  evocation:[
    "If things went better in 3 months, what would be different?",
    "What tells you you could do a little of that now?",
    "What are two good reasons to try?",
    "How important is this 0–10? And why that number?"],
};

// ------------------------
// Helpers
// ------------------------
const $=sel=>document.querySelector(sel);
const $all=sel=>[...document.querySelectorAll(sel)];
function save(){
  state.savedAt=Date.now();
  const days=parseInt($('#retention').value||'30',10);
  if(days===0||state.modePractice){ return; }
  localStorage.setItem('mi_pt_coach', JSON.stringify(state));
}
function load(){
  const raw=localStorage.getItem('mi_pt_coach');
  if(!raw) return;
  try{ const s=JSON.parse(raw);
    Object.assign(state,s);
  }catch(e){}
}
function purge(){ localStorage.removeItem('mi_pt_coach'); }
function fmtPct(n){return Math.round(n*100)+"%"}
function clip(n,min,max){return Math.max(min, Math.min(max,n))}

// ------------------------
// UI Bindings
// ------------------------
function initTabs(){
  $all('.tab').forEach(btn=>{
    btn.addEventListener('click',()=>{
      $all('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const id=btn.dataset.tab;
      $all('.tabpane').forEach(p=>p.classList.add('hide'));
      $('#'+id).classList.remove('hide');
    })
  })
}

function renderBanks(){
  const vb=$('#valuesBank');vb.innerHTML='';
  const cb=$('#concernBank');cb.innerHTML='';
  for(const v of (PRESETS[state.setting]?.values||[])) addChip(vb,v,'value');
  for(const v of (PRESETS[state.setting]?.concerns||[])) addChip(cb,v,'concern');
}

function addChip(container,label,type){
  const el=document.createElement('button');
  el.className='chip'; el.textContent=label;
  el.addEventListener('click',()=>{
    // on click, move to Must bucket by default
    pushAgenda(label);
    renderAgenda(); save();
  });
  container.appendChild(el);
}

function pushAgenda(item){
  // Cycle if already present
  const buckets=['Must','If','Defer'];
  let foundBucket=null;
  for(const k of buckets){
    const i=state.agenda[k].indexOf(item);
    if(i>-1){ foundBucket=k; state.agenda[k].splice(i,1); break; }
  }
  let next='Must';
  if(foundBucket==='Must') next='If'; else if(foundBucket==='If') next='Defer';
  state.agenda[next].push(item);
}

function renderAgenda(){
  ['Must','If','Defer'].forEach(k=>{
    const col=$('#col'+k);
    col.innerHTML='';
    for(const item of state.agenda[k]){
      const b=document.createElement('button');
      b.className='chip'; b.textContent=item;
      b.title='Click to move to next bucket';
      b.addEventListener('click',()=>{pushAgenda(item);renderAgenda();save();});
      col.appendChild(b);
    }
  })
}

function suggestFocus(){
  // basic scoring: Must bucket gets +2, Importance + Confidence + Readiness average as weight; time budget acts as soft cap
  const imp=parseInt($('#imp').value,10), conf=parseInt($('#conf').value,10), ready=parseInt($('#ready').value,10);
  const weight=(imp+conf+ready)/3;
  const items=[...state.agenda.Must.map(x=>({name:x,score:2*weight})),
               ...state.agenda.If.map(x=>({name:x,score:1*weight})),
               ...state.agenda.Defer.map(x=>({name:x,score:0.5*weight}))];
  if(items.length===0){ $('#focusOut').textContent='(add items first)'; return; }
  items.sort((a,b)=>b.score-a.score);
  $('#focusOut').textContent=items[0].name;
}

function bindStageRulers(){
  ['imp','conf','ready'].forEach(id=>{
    $('#'+id).addEventListener('input', e=>{
      $('#'+id+'Val').textContent=e.target.value;
      save();
      updateCoachStrategy();
    })
  });
}

function renderOARS(){
  const cont=$('#oarsBtns'); cont.innerHTML='';
  const mk=(label,arr,kind)=>{
    const btn=document.createElement('button');
    btn.className='btn'; btn.textContent=label; btn.style.width='100%';
    btn.addEventListener('click',()=>{
      const line=arr[Math.floor(Math.random()*arr.length)];
      showPrompt(line); bumpOARS(kind);
    });
    cont.appendChild(btn);
  };
  mk('Open question',OARS.open,'open');
  mk('Affirmation',OARS.affirm,'affirm');
  mk('Reflection (simple)',OARS.reflSimple,'reflS');
  mk('Reflection (complex)',OARS.reflComplex,'reflC');
  mk('Summary',OARS.summary,'summary');
  const kb=(e)=>{
    if(['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
    const k=e.key.toLowerCase();
    if(k==='o') cont.children[0].click();
    if(k==='a') cont.children[1].click();
    if(k==='r') cont.children[2].click();
    if(k==='s') cont.children[4].click();
    if(k==='u') undo();
  };
  window.addEventListener('keydown',kb);
}

let promptHistory=[];
function showPrompt(text){
  $('#livePrompt').textContent=text;
  promptHistory.push(text); if(promptHistory.length>50) promptHistory.shift();
}
function undo(){
  const last=promptHistory.pop();
  if(last) $('#livePrompt').textContent=promptHistory[promptHistory.length-1]||'—';
}

function bumpOARS(kind){
  if(kind==='open') state.oars.openQ++;
  if(kind==='affirm') state.oars.affirm++;
  if(kind==='reflS') state.oars.reflSimple++;
  if(kind==='reflC') state.oars.reflComplex++;
  if(kind==='summary') state.oars.summary++;
  save(); updateMetrics(); gainXP(2);
}

function renderDARNCAT(){
  const cont=$('#darncatBtns');cont.innerHTML='';
  const items=[['D','Desire'],['A','Ability'],['R','Reasons'],['N','Need'],['C','Commit'],['T','Taking steps'],['Sustain','Sustain talk']];
  for(const [k,label] of items){
    const b=document.createElement('button'); b.className='btn'; b.textContent=label; b.style.width='100%';
    b.addEventListener('click',()=>{ state.darncat[k]=(state.darncat[k]||0)+1; updateCT(); save(); gainXP(1); });
    cont.appendChild(b);
  }
}

function updateCT(){
  const {D,A,R,N,C,T,Sustain}=state.darncat;
  const ct=D+A+R+N+C+T; const st=Sustain; const total=ct+st;
  const pct = total? Math.round((ct/total)*100):0;
  $('#ctPct').textContent=pct+'%';
  $('#stCnt').textContent=st;
  $('#hiCnt').textContent=state.highlights.length;
  renderHeat(); updateMetrics();
}

function renderHeat(){
  const map=[['D','Desire'],['A','Ability'],['R','Reasons'],['N','Need'],['C','Commit'],['T','Steps']];
  const box=$('#ctHeat'); box.innerHTML='';
  for(const [k,lab] of map){
    const n=state.darncat[k]||0; const cls=n>=3?'good':n>=1?'meh':'bad';
    const el=document.createElement('div'); el.className='badge '+cls; el.textContent=lab+': '+n;
    box.appendChild(el);
  }
}

function updateMetrics(){
  const q=state.oars.openQ+state.oars.closedQ;
  const refl=state.oars.reflSimple+state.oars.reflComplex;
  const rq=q? (refl/q): (refl?refl:0);
  $('#rq').textContent=rq.toFixed(2);
  $('#ratioBar').style.width=clip(rq/2,0,1)*100+'%';
  // Debrief
  const openPct=q?Math.round((state.oars.openQ/q)*100):0;
  const crPct=(refl? Math.round((state.oars.reflComplex/refl)*100):0);
  $('#mOpen').textContent=openPct+'%';
  $('#mRQ').textContent=rq.toFixed(2);
  $('#mCR').textContent=crPct+'%';
  updateBadges(openPct,rq,crPct);
}

function updateCoachStrategy(){
  // SDT prompts & BCT suggestions based on COM-B toggles + rulers
  const cap=$('#cCap').checked, opp=$('#cOpp').checked, mot=$('#cMot').checked;
  const bcts=[]; if(cap) bcts.push(...BCTS.cap); if(opp) bcts.push(...BCTS.opp); if(mot) bcts.push(...BCTS.mot);
  state.comB={cap:cap,opp:opp,mot:mot,bcts:[...new Set(bcts)]};
  const box=$('#bctTags'); box.innerHTML='';
  for(const t of state.comB.bcts){ const d=document.createElement('span'); d.className='pill'; d.textContent=t; box.appendChild(d);} 
  const imp=parseInt($('#imp').value,10), conf=parseInt($('#conf').value,10);
  const sdt=[];
  // Autonomy-support examples
  sdt.push("Would you like to focus on "+($('#focusOut').textContent||'what matters most')+" or explore other options?");
  // Competence-support
  if(conf<7) sdt.push("On a scale of 0–10, what would move confidence from "+conf+" to "+(conf+1)+"?");
  // Relatedness-support
  if(opp) sdt.push("Who could be on your support team for this?");
  $('#sdtPrompts').innerHTML = '<ul>'+sdt.map(x=>'<li class="mini">'+x+'</li>').join('')+'</ul>';
}

function addHighlight(){
  const t=$('#livePrompt').textContent.trim(); if(!t) return;
  state.highlights.push(t); save(); updateCT(); renderHighlights(); gainXP(1);
}
function renderHighlights(){
  const box=$('#highlights'); box.innerHTML='';
  for(const h of state.highlights){ const d=document.createElement('span'); d.className='pill'; d.textContent=h; box.appendChild(d);} 
}

function saveBAP(){
  const plan=$('#bapTry').value.trim(); if(!plan) return alert('Enter a BAP plan.');
  const conf=parseInt($('#bapConf').value,10), imp=parseInt($('#bapImp').value,10), fu=parseInt($('#bapFU').value,10);
  const addBCTs = conf<7 ? ["Graded tasks","Action planning","Social support (practical)"] : ["Review behavior goals","Feedback on behavior"];
  state.bap={plan,conf,imp,followUpDays:fu,bcts:addBCTs}; save(); gainXP(5);
  alert('BAP saved.');
}

function saveGoal(){
  const g={
    specific:$('#gSpecific').value.trim(),
    metric:$('#gMetric').value.trim(),
    challenge:$('#gChallenge').value,
    feedback:$('#gFeedback').value,
    ifThen:$('#ifThen').value.trim(),
    woopWO:$('#woopWO').value.trim(),
    woopOP:$('#woopOP').value.trim()
  };
  if(!g.specific){ return alert('Enter a specific goal.'); }
  state.goal=g; save(); gainXP(8);
  alert('Goal saved.');
}

function copy(text){
  $('#exportOut').classList.remove('hide');
  $('#exportOut').value=text; $('#exportOut').select(); document.execCommand('copy');
  setTimeout(()=>$('#exportOut').classList.add('hide'),600);
}

function exportNote(){
  const ttm=$('#stage').value;
  const imp=$('#imp').value, conf=$('#conf').value, ready=$('#ready').value;
  const focus=$('#focusOut').textContent;
  const comB = Object.entries(state.comB).filter(([k,v])=>['cap','opp','mot'].includes(k)&&v).map(([k])=>k).join(', ')||'none';
  const darn = state.darncat;
  const note = `Subjective: Values ${state.values?.join(', ')||'(selected via chips)'}; Agenda focus: ${focus}.\n\
Stage: ${ttm}. Importance ${imp}/10, Confidence ${conf}/10, Readiness ${ready}/10.\n\
Objective: OARS counts—Open ${state.oars.openQ}, Affirm ${state.oars.affirm}, Refl(S) ${state.oars.reflSimple}, Refl(C) ${state.oars.reflComplex}, Summary ${state.oars.summary}. DARN-CAT—D${darn.D}/A${darn.A}/R${darn.R}/N${darn.N}/C${darn.C}/T${darn.T}; Sustain ${darn.Sustain}.\n\
Assessment: COM‑B gaps ${comB}.\n\
Plan: ${state.bap?('BAP: '+state.bap.plan+' (conf '+state.bap.conf+'/10, FU '+state.bap.followUpDays+'d, BCTs: '+state.bap.bcts.join('; ')+')'):'—'}; ${state.goal?('Goal: '+state.goal.specific+' ('+state.goal.metric+'); If‑Then: '+state.goal.ifThen+'; WOOP '+state.goal.woopWO+' / '+state.goal.woopOP):''}.`;
  copy(sanitizePHI(note));
}

function exportPlan(){
  const plan = `What matters: ${state.values.slice(0,3).join(', ')||'(your values)'}\n\
Top focus: ${$('#focusOut').textContent}\n\
Brief Action Plan: ${state.bap?state.bap.plan:'(decide together)'}\n\
Confidence: ${state.bap?state.bap.conf:'/10'}  |  Check‑in: ${state.bap?state.bap.followUpDays+' days':'—'}\n\
If‑Then plan: ${state.goal?state.goal.ifThen:'—'}\n\
WOOP: ${state.goal?state.goal.woopWO+' | '+state.goal.woopOP:'—'}\n\
Support: ${state.comB.opp?'Line up a helper / reminder':'Pick a prompt you like (calendar, sticky note)'}\n\
You’ve got this—start small, keep score once, and we’ll adjust next time.`;
  copy(sanitizePHI(plan));
}

function sanitizePHI(text){
  return state.phiSafe ? text.replace(/(name|dob|mrn|phone|email|address)\s*[:=].*/gi,'[redacted]') : text;
}

function downloadJSON(){
  const safe={...state};
  delete safe.phi; delete safe.modePractice; // de‑identify-ish snapshot
  const blob=new Blob([JSON.stringify(safe,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='mi_pt_session.json'; a.click(); URL.revokeObjectURL(url);
}

function copySummary(){
  const ct=state.darncat; const ctTotal=ct.D+ct.A+ct.R+ct.N+ct.C+ct.T+ct.Sustain;
  const sum = `De‑identified summary\nStage: ${$('#stage').value}\nFocus: ${$('#focusOut').textContent}\nOARS: O ${state.oars.openQ}, A ${state.oars.affirm}, R ${state.oars.reflSimple+state.oars.reflComplex}, S ${state.oars.summary}\nChange talk: ${ct.D+ct.A+ct.R+ct.N+ct.C+ct.T}/${ctTotal} (${ $('#ctPct').textContent })\nBCTs used: ${(state.comB.bcts||[]).join('; ')}`;
  copy(sum);
}

function gainXP(n){ state.xp+=n; updateBadges(); }
function updateBadges(openPct, rq, crPct){
  const add=(b)=>{ if(!state.badges.includes(b)){ state.badges.push(b);} };
  if(openPct>=70) add('Curious Clinician');
  if((rq||0)>=1.0) add('Reflective Listener');
  if((crPct||0)>=40) add('Complex Reflections');
  if(state.highlights.length>=3) add('Evoke First');
  const box=$('#achieve'); box.innerHTML='';
  for(const b of state.badges){ const d=document.createElement('span'); d.className='badge good'; d.textContent=b; box.appendChild(d);} 
}

// Patient 10‑sec reset based on form data
function generatePatientReset(){
  const top=$('#focusOut').textContent||'what matters to you';
  const stage=$('#stage').value;
  const cap=$('#cCap').checked, opp=$('#cOpp').checked, mot=$('#cMot').checked;
  const conf=parseInt($('#conf').value,10), imp=parseInt($('#imp').value,10);
  const piece1 = 'Breathe 3× (in 3, hold 1, out 4). Relax jaw/shoulders.';
  let piece2 = `Picture ${top} going well this week.`;
  if(conf<7) piece2 = `Picture a tiny win toward ${top} (\u22481–3 min).`;
  let piece3 = 'Say: “I can do a little.”';
  if(cap) piece3 = 'Say: “I know *how* to do a little.”';
  if(opp) piece3 = 'Say: “I have a cue/support for this.”';
  if(mot && imp>=7) piece3 = 'Say: “This matters to me.”';
  const piece4 = (state.goal?.ifThen? ('If '+ state.goal.ifThen) : 'If a barrier pops up, switch to your fallback option.');
  const script = `10‑sec reset → ${piece1} ${piece2} ${piece3} ${piece4}`;
  $('#patientReset').textContent=script; return script;
}

// PT 10‑sec reset animation
let ptTimer=null,ptT=0;
function showPTReset(){
  clearInterval(ptTimer); ptT=0; $('#ptReset').classList.remove('hide');
  const lines=[
    'Notice your urge to fix → let it pass.','Set intention: evoke, affirm, reflect.','One open question you’ll ask next.',
  ];
  $('#ptScript').textContent=lines[0];
  ptTimer=setInterval(()=>{
    ptT+=100; const pct=clip(ptT/10000,0,1); $('#ptBar').style.width=(pct*100)+'%';
    if(ptT===3500) $('#ptScript').textContent=lines[1];
    if(ptT===7000) $('#ptScript').textContent=lines[2];
    if(ptT>=10000){ clearInterval(ptTimer); }
  },100);
}
function hidePTReset(){ clearInterval(ptTimer); $('#ptReset').classList.add('hide'); $('#ptBar').style.width='0%'; }

// Drills
let drillInt=null, drillT=0;
function startDrill(kind){
  const seq=DRILLS[kind]; if(!seq) return;
  $('#drillPrompt').textContent=seq[0]; drillT=0; $('#drillBar').style.width='0%';
  clearInterval(drillInt);
  drillInt=setInterval(()=>{
    drillT+=1000; const i=Math.floor(drillT/30000*seq.length); // rotate over 30s blocks
    $('#drillPrompt').textContent=seq[Math.min(i,seq.length-1)];
    $('#drillBar').style.width=clip(drillT/(kind==='affirmations'?90000:120000),0,1)*100+'%';
    if( (kind==='affirmations' && drillT>=90000) || (kind!=='affirmations' && drillT>=120000)) clearInterval(drillInt);
  },1000);
}
function stopDrill(){ clearInterval(drillInt); $('#drillBar').style.width='0%'; $('#drillPrompt').textContent='Stopped.'; }

// ------------------------
// Event wiring
// ------------------------
function wire(){
  initTabs();
  $('#loadPreset').addEventListener('click',()=>{ state.setting=$('#settingPreset').value; renderBanks(); save(); });
  $('#addValue').addEventListener('click',()=>{
    const v=$('#customValue').value.trim(); if(!v) return; PRESETS[state.setting].values.push(v); $('#customValue').value=''; renderBanks();
  });
  $('#addConcern').addEventListener('click',()=>{
    const v=$('#customConcern').value.trim(); if(!v) return; PRESETS[state.setting].concerns.push(v); $('#customConcern').value=''; renderBanks();
  });
  $('#btnFocus').addEventListener('click',suggestFocus);
  $('#stage').addEventListener('change',e=>{state.stage=e.target.value; save();});
  $('#timeBudget').addEventListener('change',e=>{state.timeBudget=parseInt(e.target.value,10); save();});
  bindStageRulers();
  renderOARS();
  renderDARNCAT();
  $('#btnUndo').addEventListener('click',undo);
  $('#btnAddHighlight').addEventListener('click',addHighlight);
  ['cCap','cOpp','cMot'].forEach(id=>$('#'+id).addEventListener('change',updateCoachStrategy));
  $('#saveBAP').addEventListener('click',saveBAP);
  $('#saveGoal').addEventListener('click',saveGoal);
  $('#exportNote').addEventListener('click',exportNote);
  $('#exportPlan').addEventListener('click',exportPlan);
  $('#exportJSON').addEventListener('click',downloadJSON);
  $('#copySummary').addEventListener('click',copySummary);
  $('#btnPTReset').addEventListener('click',showPTReset);
  $('#btnPatientReset').addEventListener('click',generatePatientReset);
  $('#purge').addEventListener('click',()=>{purge(); alert('Local data cleared.');});
  $('#modePractice').addEventListener('change',e=>{state.modePractice=e.target.checked; save();});
  $('#phiToggle').addEventListener('change',e=>{state.phiSafe=e.target.checked; save();});
}

// ------------------------
// Boot
// ------------------------
load();
wire();
$('#settingPreset').value=state.setting; renderBanks(); renderAgenda(); updateCoachStrategy(); updateMetrics(); updateCT(); renderHighlights();

</script>
</body>
</html>
